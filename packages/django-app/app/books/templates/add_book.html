{% extends "base.html" %}

{% block title %}Add Book - Glerk{% endblock %}

{% block header %}Add Book{% endblock %}

{% block content %}
<form method="post" id="add-book-form">
    {% csrf_token %}
    {% for field in form %}
        <label for="{{ field.id_for_label }}">
            {{ field.label }}
        </label>
        <input type="{{ field.field.widget.input_type }}"
               name="{{ field.name }}"
               id="{{ field.id_for_label }}"
               {% if field.field.required %}required{% endif %}>
    {% endfor %}
    <label for="barcode-input">Scan Barcode</label>
    <input type="text"
           id="barcode-input"
           placeholder="SCAN ISBN HERE">
    <button type="submit">ADD BOOK TO DATABASE</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const barcodeInput = document.getElementById('barcode-input');
        barcodeInput.focus();
        barcodeInput.addEventListener('input', function() {
            const isbn = this.value;
            if (isbn.length === 13) {  // Assuming ISBN-13
                fetchBookInfo(isbn);
            }
        });
    });

    function fetchBookInfo(isbn) {
        fetch(`https://openlibrary.org/api/books?bibkeys=ISBN:${isbn}&format=json&jscmd=data`)
            .then(response => response.json())
            .then(data => {
                const bookData = data[`ISBN:${isbn}`];
                if (bookData) {
                    document.getElementById('id_title').value = bookData.title;
                    document.getElementById('id_author').value = bookData.authors ? bookData.authors[0].name : '';
                    document.getElementById('id_isbn').value = isbn;
                    document.getElementById('id_publication_date').value = bookData.publish_date;
                }
            })
            .catch(error => console.error('Error fetching book data:', error));
    }
</script>
{% endblock %}
